name: Nightly Merge

on:
  schedule:
    - cron: "0 0 * * *" # Run every night at midnight
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write # Allows write access to repository contents
  pull-requests: write # Allows write access to pull requests (if applicable)

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: Fetch latest dev branch
        run: |
          git fetch origin
          git checkout dev

      - name: Merge dev into feature branches
        run: |
          # Get list of all feature branches
          for branch in $(git branch -r | grep 'origin/feature/'); do
            git checkout "$branch"
            git merge origin/dev
            if [ $? -ne 0 ]; then
              # Capture conflict details
              echo "Merge conflict detected in $branch, please resolve conflicts manually." >> merge_failures.txt
              # Log the conflicting files
              git diff --name-only --diff-filter=U >> merge_failures.txt
            else
              echo "Successfully merged dev into $branch"
            fi
          done

      - name: Push merged feature branches
        run: |
          # Push all successfully merged branches
          git push

      - name: Notify if any merge conflicts occurred
        run: |
          if [ -s merge_failures.txt ]; then
            echo "Merge conflicts occurred in the following branches:"
            cat merge_failures.txt
            # Send notification (e.g., Slack, email) or log the failures
          else
            echo "All feature branches successfully merged with dev."
          fi
