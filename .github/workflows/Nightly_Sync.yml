name: Rebase Dev onto Feature Branches

# This workflow is triggered in two ways:
# 1. On a schedule: every day at 2am Pacific Time (which is 9am UTC)
# 2. Manually, via the GitHub Actions UI (workflow_dispatch)
on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  rebase:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure latest GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Fetch all branches
        run: git fetch --all

      - name: List all open feature branches
        id: list_branches
        run: |
          git branch -r | grep 'origin/feature/' | sed 's|origin/||' > feature_branches.txt
          echo "branches=$(cat feature_branches.txt | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

      - name: Rebase dev onto each feature branch
        env:
          BRANCHES: ${{ steps.list_branches.outputs.branches }}
        run: |
          > rebase_failures.txt
          IFS=',' read -ra BRANCH_ARRAY <<< "$BRANCHES"
          for branch in "${BRANCH_ARRAY[@]}"; do
            echo "Processing $branch..."
            git checkout $branch
            if git rebase origin/dev; then
              git push origin $branch --force-with-lease
              echo "✅ Successfully rebased and pushed $branch"
            else
              echo "❌ Conflict detected in $branch"
              author_info=$(git log -1 --pretty=format:'%an <%ae>')
              echo "- Branch: $branch | Author: $author_info" >> rebase_failures.txt
              git rebase --abort
            fi
          done

      - name: Report rebase conflicts
        if: always()
        run: |
          if [ -s rebase_failures.txt ]; then
            echo "### 🚨 Rebase conflicts detected!" >> $GITHUB_STEP_SUMMARY
            cat rebase_failures.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ No rebase conflicts detected." >> $GITHUB_STEP_SUMMARY
          fi
